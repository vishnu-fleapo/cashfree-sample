<!-- <!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashfree Checkout Integration</title>
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
</head>

<body>
    <div class="row">
        <p>Enter details and click Pay</p>

        <input type="number" id="amount" placeholder="Enter Amount" />
        <br /><br />

        <input type="text" id="phone" placeholder="Enter Phone Number" />
        <br /><br />

        <button id="renderBtn">Pay Now</button>
    </div>

    <script>
        const cashfree = Cashfree({
            mode: "sandbox",
        });

        document.getElementById("renderBtn").addEventListener("click", async () => {
            try {

                const amount = document.getElementById("amount").value.trim();
                const phone = document.getElementById("phone").value.trim();

                if (!amount || !phone) {
                    alert("Please enter amount and phone number");
                    return;
                }

                const response = await fetch(
                    "http://localhost:6767/api/payment/create-order",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            orderAmount: Number(amount),
                            customerId: "cust_" + Date.now(),
                            customerPhone: phone
                        })
                    }
                );

                const data = await response.json();

                if (!data.payment_session_id) {
                    alert("Failed to create order");
                    return;
                }

                cashfree.checkout({
                    paymentSessionId: data.payment_session_id,
                    redirectTarget: "_modal",
                }).then(async (result) => {

                    if (result.error) {
                        showPopup("❌ Payment cancelled or failed");
                        return;
                    }

                    if (result.paymentDetails) {

                        const orderId = result.paymentDetails.orderId;

                        const verifyResponse = await fetch(
                            `http://localhost:6767/api/payment/verify/${orderId}`
                        );

                        const verifyData = await verifyResponse.json();

                        if (verifyData.order_status === "PAID") {
                            showPopup("✅ Payment Successful!");
                        } else {
                            showPopup("❌ Payment Failed or Pending");
                        }
                    }

                });

            } catch (error) {
                console.error(error);
                showPopup("Something went wrong");
            }
        });

        function showPopup(message) {
            const popup = document.createElement("div");
            popup.innerHTML = message;
            popup.style.position = "fixed";
            popup.style.top = "50%";
            popup.style.left = "50%";
            popup.style.transform = "translate(-50%, -50%)";
            popup.style.background = "#000";
            popup.style.color = "#fff";
            popup.style.padding = "20px 40px";
            popup.style.borderRadius = "8px";
            popup.style.fontSize = "18px";
            popup.style.zIndex = "9999";

            document.body.appendChild(popup);

            setTimeout(() => popup.remove(), 3000);
        }
    </script>

</body>

</html> -->

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Service Checkout</title>

    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        background: #f5f7fb;
        margin: 0;
        padding: 40px;
      }

      .container {
        max-width: 720px;
        margin: auto;
        background: #fff;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      }

      h2 {
        margin-bottom: 12px;
      }

      input,
      button {
        width: 100%;
        padding: 12px;
        margin-bottom: 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
      }

      button {
        background: #4f46e5;
        color: white;
        border: none;
        font-weight: 600;
        cursor: pointer;
      }

      button:hover {
        background: #4338ca;
      }

      .service {
        border: 1px solid #e5e7eb;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
      }

      .service:hover {
        background: #f9fafb;
      }

      .service.selected {
        border-color: #4f46e5;
        background: #eef2ff;
      }

      .section {
        margin-top: 24px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h2>User</h2>
      <input id="userId" placeholder="Enter User ID" />

      <button onclick="loadServices()">Load Services</button>

      <div class="section">
        <h2>Available Services</h2>
        <div id="services"></div>
      </div>

      <div class="section">
        <h2>Payment</h2>

        <input id="amount" type="number" placeholder="Amount" readonly />
        <input id="phone" placeholder="Phone Number" />

        <button id="payBtn">Pay Now</button>
        <div
          id="paymentStatus"
          style="margin-top: 10px; font-weight: 600"
        ></div>
      </div>

      <div class="section">
        <h2>My Purchases</h2>
        <button onclick="loadUserPurchases()">Load My Purchases</button>
        <div id="purchases"></div>
      </div>
    </div>

    <script>
      const cashfree = Cashfree({ mode: "sandbox" });
      let selectedService = null;

      const statusEl = document.getElementById("paymentStatus");

      function setStatus(message, success = true) {
        statusEl.innerText = message;
        statusEl.style.color = success ? "green" : "red";
      }

      async function loadServices() {
        const servicesEl = document.getElementById("services");
        servicesEl.innerHTML = "Loading...";

        const res = await fetch("http://localhost:6767/api/services");
        const services = await res.json();

        servicesEl.innerHTML = "";

        services.forEach((s) => {
          const div = document.createElement("div");
          div.className = "service";
          div.innerHTML = `
        <strong>${s.title}</strong><br>
        ${s.currency} ${s.price}
      `;

          div.onclick = () => {
            document
              .querySelectorAll(".service")
              .forEach((el) => el.classList.remove("selected"));

            div.classList.add("selected");
            selectedService = s;
            document.getElementById("amount").value = s.price;
          };

          servicesEl.appendChild(div);
        });
      }

      async function loadUserPurchases() {
        const userId = document.getElementById("userId").value;
        if (!userId) {
          setStatus("Enter user ID first", false);
          return;
        }

        const purchasesEl = document.getElementById("purchases");
        purchasesEl.innerHTML = "Loading...";

        const res = await fetch(
          `http://localhost:6767/api/services/user?userId=${userId}`,
        );

        const data = await res.json();
        console.log(data);
        if (!data || data.length === 0) {
          purchasesEl.innerHTML = "<p>No purchases found</p>";
          return;
        }

        purchasesEl.innerHTML = "";

        data.forEach(({ services, payments, created_at }) => {
          const div = document.createElement("div");
          div.className = "service";
          div.innerHTML = `
        <strong>${services?.title || "Service"}</strong><br>
        Amount: ₹${payments?.amount || 0}<br>
        Status: ${payments?.status}<br>
        Purchased: ${new Date(created_at).toLocaleString()}
      `;
          purchasesEl.appendChild(div);
        });
      }

      document.getElementById("payBtn").addEventListener("click", async () => {
        if (!selectedService) {
          setStatus("Select a service first", false);
          return;
        }

        const phone = document.getElementById("phone").value;
        const userId = document.getElementById("userId").value;

        if (!phone || !userId) {
          setStatus("User ID and phone are required", false);
          return;
        }

        setStatus("Creating order...");

        const response = await fetch(
          "http://localhost:6767/api/payment/create-order",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              orderAmount: selectedService.price,
              customerId: userId,
              customerPhone: phone,
              serviceId: selectedService.id,
            }),
          },
        );

        const data = await response.json();
        if (!data.payment_session_id) {
          setStatus("Order creation failed", false);
          return;
        }

        cashfree
          .checkout({
            paymentSessionId: data.payment_session_id,
            redirectTarget: "_modal",
          })
          .then(async (result) => {
            if (result.error) {
              setStatus("Payment cancelled", false);
              return;
            }

            if (!result.paymentDetails) {
              setStatus("Payment processing...");
              return;
            }

            const orderId = data.order_id;

            const verify = await fetch(
              `http://localhost:6767/api/payment/verify/${orderId}`,
            );

            const verifyData = await verify.json();

            if (verifyData.payment?.status === "SUCCESS") {
              setStatus("Payment Successful ✅");
              loadUserPurchases();
            } else {
              setStatus("Payment Failed or Pending ❌", false);
            }
          })
          .catch((e) => {
            console.error(e);
            setStatus("Payment failed. Try again.", false);
          });
      });
    </script>
  </body>
</html>
